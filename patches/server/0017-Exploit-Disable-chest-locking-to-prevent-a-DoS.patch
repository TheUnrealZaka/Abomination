From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Xymb <xymb@endcrystal.me>
Date: Fri, 9 Aug 2024 04:26:42 +0200
Subject: [PATCH] Exploit: Disable chest locking to prevent a DoS

Fixes "open a chest full of shulkers 100 times per second" lag method

diff --git a/src/main/java/abomination/config/Exploit.java b/src/main/java/abomination/config/Exploit.java
index 50a6cfabb15d1f0acd1646a8c98b649c02671f4f..0ff1235be2ece9c90e2f5d424c105e57a73b227f 100644
--- a/src/main/java/abomination/config/Exploit.java
+++ b/src/main/java/abomination/config/Exploit.java
@@ -1,4 +1,5 @@
 package abomination.config;
 
 public class Exploit {
+    public static boolean disableChestLocking = false; // Chest locking in Minecraft is extremely slow. Opening a double chest full of shulkers as fast as possible takes MSPT to 175 in my test.
 }
diff --git a/src/main/java/net/minecraft/world/level/block/entity/BaseContainerBlockEntity.java b/src/main/java/net/minecraft/world/level/block/entity/BaseContainerBlockEntity.java
index 2ddf349fde5b310ec3f74baee1f3d33e09d5286c..96421dc8a20349f8fdca66c1abdec714c9b6bff4 100644
--- a/src/main/java/net/minecraft/world/level/block/entity/BaseContainerBlockEntity.java
+++ b/src/main/java/net/minecraft/world/level/block/entity/BaseContainerBlockEntity.java
@@ -82,6 +82,7 @@ public abstract class BaseContainerBlockEntity extends BlockEntity implements Co
         return canUnlock(player, lock, containerName, null);
     }
     public static boolean canUnlock(Player player, LockCode lock, Component containerName, @Nullable BlockEntity blockEntity) {
+        if (abomination.config.Exploit.disableChestLocking) return true; // Abomination
         if (player instanceof net.minecraft.server.level.ServerPlayer serverPlayer && blockEntity != null && blockEntity.getLevel() != null && blockEntity.getLevel().getBlockEntity(blockEntity.getBlockPos()) == blockEntity) {
             final org.bukkit.block.Block block = org.bukkit.craftbukkit.block.CraftBlock.at(blockEntity.getLevel(), blockEntity.getBlockPos());
             net.kyori.adventure.text.Component lockedMessage = net.kyori.adventure.text.Component.translatable("container.isLocked", io.papermc.paper.adventure.PaperAdventure.asAdventure(containerName));
